---
title: "TABLE 2: Explaining Pejoration Using Countriesâ€™ Media History"
---

## Preparation

This chunk imports the following packages.
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
library(data.table)
library(psych)
library(brms)
library(ggmcmc)
library(mcmcplots)
library(dplyr)
library(gsubfn)
library(psych)
library(ggplot2)
library(readxl)
library(ggpubr)
library(broom)
library(sjstats)
library(sjmisc)
```

This chunk imports the data with the validated content analysis:
```{r message=FALSE, warning=FALSE, paged.print=FALSE}
agg = read_excel("/aggregate_validated.xlsx") # Change directory prior to running 
```

Dependent variable: if one of the types of pejoration is present, code as '1'
```{r}
agg$stigma = 0 
agg$stigma[agg$st_antidem_m == 1 | agg$st_hist_m == 1 | agg$st_ill_m == 1 | agg$st_cont_m == 1 | agg$st_pop_m == 1] = 1 
```

Clustering levels: 
```{r}
agg$outletyear = paste0(agg$outlet, agg$year)
```

Specify measurement level of variables in the analysis and produce overview
```{r}
agg$outlet = factor(agg$outlet)

print("(1) Dependent variable: Stigmatization")
agg$stigma = as.numeric(agg$stigma)
table(agg$stigma) 
  
print("(2) Independent variable: Professionalism")
agg$prof_trad = as.factor(agg$prof_trad)
agg$prof_trad = factor(agg$prof_trad ,levels(agg$prof_trad)[c(2,3,1)])
table(agg$prof_trad)
  
print("(3) Independent variable: Parallelism")
agg$par_trad = as.factor(agg$par_trad)
agg$par_trad = factor(agg$par_trad ,levels(agg$par_trad)[c(2,3,1)])
table(agg$par_trad)
  
print("(4) Independent variable: Authoritarian Legacy")
table(agg$aut)
  
print("(5) Independent variable: Political Leaning")
agg$lr = as.factor(agg$lr)
agg$lr = factor(agg$lr ,levels(agg$lr)[c(2,3,1)])
table(agg$lr)
  
print("(6) Independent variable: Political Leaning Binary")
agg$lr_b = agg$lr 
agg$lr_b[agg$lr=="center"] = NA
table(agg$lr_b)
  
print("(7) Independent variable: Length")
agg$length = as.numeric(agg$length)
describe(agg$length)
```

Functions: 
```{r}
# Predicted Probabilities
logit_prob = function(logit){
  odds = exp(logit)
  prob = odds / (1 + odds)
  return(prob)}
```

## Analyses

Full analyses:
```{r}
# Model 1a
m1a = brm(
  stigma ~  prof_trad + lr + length + (1 | outlet) + (1 | cntry) + (1 | year) + (1 + outletyear),
  data = agg, family = "bernoulli", chains = 2, silent= TRUE, refresh=0, 
  open_progress = FALSE, warmup = 1500, iter = 4500, cores=2, seed=123)

# Model 1b
m1b = brm(
  stigma ~ par_trad + lr_b + length + par_trad*lr_b + (1 | outlet) + (1 | cntry) + (1 | year) + (1 + outletyear),
  data = agg,  family = "bernoulli",  chains = 2, silent = TRUE,  refresh = 0, open_progress = FALSE, 
  warmup = 1500, iter = 4500, cores = 2, seed = 123, save_all_pars = TRUE, inits = "random")

print(summary(m1a), digits = 3)
print(summary(m1b), digits = 3)

# intra-class correlation
icc(m1a, re.form = NULL, typical = "mean", ppd = FALSE, digits = 4)
icc(m1b, re.form = NULL, typical = "mean", ppd = FALSE, digits = 4)

# Information criteria
m1a = add_criterion(m1a, c("loo"))
m1b = add_criterion(m1b, c("loo"))
bayes_R2(m1a, resp = NULL, summary = TRUE, robust = FALSE, probs = c(0.025, 0.975))
bayes_R2(m1b, resp = NULL, summary = TRUE, robust = FALSE, probs = c(0.025, 0.975))
```

Partial Analyses: 
```{r}
# Model 1a
quiet(m1a_partial = brm(
  stigma ~  prof_trad + (1 | outlet) + (1 | cntry) + (1 | year) + (1 + outletyear),
  data = agg, family = "bernoulli", chains = 2, silent= TRUE, refresh=0, 
  open_progress = FALSE, warmup = 1500, iter = 4500, cores=2, seed=123))

# Model 1b
quiet(m1b_partial = brm(
  stigma ~ par_trad + lr_b + par_trad*lr_b + (1 | outlet) + (1 | cntry) + (1 | year) + (1 + outletyear),
  data = agg, family = "bernoulli", chains = 2, silent= TRUE, refresh=0, 
  open_progress = FALSE, warmup = 1500, iter = 4500, cores=2, seed=123))

# Information criteria
m1a_partial = bayes_R2(m1a_partial, resp = NULL, summary = TRUE, robust = FALSE, probs = c(0.025, 0.975))
m1b_partial = bayes_R2(m1b_partial, resp = NULL, summary = TRUE, robust = FALSE, probs = c(0.025, 0.975))
```

## Predicted Probabilities

```{r}
# Model 1a: Main Effect Professionalism
print(paste("Low Professionalism:", logit_prob(-0.762)))
print(paste("Medium Professionalism:", logit_prob(-0.762 - 0.767)))
print(paste("High Professionalism:", logit_prob(-0.762 - 0.877)))

print(paste("Diff. Low - Medium:", logit_prob(-0.762 - 0.767) - logit_prob(-0.762)))
print(paste("Diff. Low - High:", logit_prob(-0.762 - 0.877) - logit_prob(-0.762)))

# Model 1b: Interaction Paralellism * Ideology
print(paste("Left-leaning newspapers, low parallelism", logit_prob(-1.481)))
print(paste("Right-leaning newspapers, low parallelism", logit_prob(-1.481 - 0.126)))

print(paste("Left-leaning newspapers, medium parallelism", logit_prob(-1.481 - 0.053)))
print(paste("Right-leaning newspapers, medium parallelism", logit_prob(-1.481 - 0.053 + 0.128)))

print(paste("Left-leaning newspapers, high parallelism", logit_prob(-1.481 + 0.471)))
print(paste("Right-leaning newspapers, high parallelism", logit_prob(-1.481 + 0.471 + 0.075)))

print(paste("Diff. left - right, low parallelism", logit_prob(-1.481) - logit_prob(-1.481 -0.126)))
print(paste("Diff. left - right, medium parallelism", logit_prob(-1.481 - 0.053) - logit_prob(-1.481 - 0.053 + 0.128)))
print(paste("Diff. left - right, high parallelism", logit_prob(-0.706 + 0.471) - logit_prob(-1.481 + 0.471 + 0.075)))
```

## Convergence

Create vector of estimated parameter values produced in iterations:
```{r}
# Model 1a
modeltranformed_m1a = ggs(m1a)
# Model 1b
modeltranformed_m1b = ggs(m1b)
```

Catterpillar plots:
```{r}
# Model 1a
catterpillar_m1a = ggplot(
 filter(modeltranformed_m1a, Parameter==c("b_Intercept", "b_prof_tradLow", "b_prof_tradMedium"), Iteration>1500),
 aes(x=Iteration, y=value, col=as.factor(Chain))) +
 geom_line() +
 facet_grid( Parameter ~ ., scale='free_y', switch = 'y')+ ylim(-3.5, 1.5) + 
 labs(title="Caterpillar Plot", col= "Chains") s
# Model 1b
catterpillar_m1b = ggplot(
 filter(modeltranformed_m1b, Parameter==c("b_Intercept", "b_par_tradHigh:lr_bright", "b_par_tradMedium:lr_bright"), Iteration>1500),
 aes(x=Iteration, y=value, col=as.factor(Chain))) +
 geom_line() +
 facet_grid(Parameter ~ ., scale='free_y', switch = 'y')+ ylim(-3.5, 1.5) + 
 labs(title="Caterpillar Plot", col= "Chains") 

catterpillar_m1a
catterpillar_m1b
```

Gelman-Rubin diagnostic:
```{r}
# Model 1a
modelposterior_m1a = as.mcmc(m1a)
gelman.diag(modelposterior_m1a[, 1])
post_plot_m1a = gelman.plot(modelposterior_m1a[, 1:3])
# Model 1b
modelposterior_m1b = as.mcmc(m1b)
gelman.diag(modelposterior_m1b[, 1])
post_plot_m1b = gelman.plot(modelposterior_m1b[, 1:7])
```

Autocorrelation:
```{r}
# Model 1a
autocorr.diag(modelposterior_m1a[,1:5], lags = c(0, 1,2,3,4, 5, 10, 50))
# Model 1b
autocorr.diag(modelposterior_m1b[,1:5], lags = c(0, 1,2,3,4, 5, 10, 50))
```

## Hypothesis Testing 

Test hypotheses:
```{r}
# Model 1a
hypothesis(m1a, "prof_tradMedium<0", alpha = 0.001)
hypothesis(m1a, "prof_tradHigh<0", alpha = 0.001)
hypothesis(m1a, "prof_tradMedium - prof_tradHigh > 0", alpha = 0.001)

# Model 1b
hypothesis(m1b, "par_tradMedium:lr_bright>0", alpha = 0.001)
hypothesis(m1b, "par_tradHigh:lr_bright>0", alpha = 0.001)
hypothesis(m1b, "par_tradHigh:lr_bright - par_tradMedium:lr_bright >0", alpha = 0.001)
```

Plot hypotheses
```{r}
h1a_1 = plot(hypothesis(m1a, "prof_tradMedium=0"), plot = F, theme = theme_get())[[1]]+ scale_x_continuous(limits=c(-3, 0.5))
h1a_2 = plot(hypothesis(m1a, "prof_tradHigh=0"), plot = F, theme = theme_get())[[1]]+ scale_x_continuous(limits=c(-3, 0.5))

h1a_test = ggarrange(h1a_1, h1a_2, heights = c(8), common.legend = TRUE, ncol = 2, nrow = 1)

h1a_test
```